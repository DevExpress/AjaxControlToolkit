version: '{build}'

os: Visual Studio 2013

init:
  - git config --global core.autocrlf true

configuration:
  - Release
  - Debug
 
cache:
  - packages -> **\packages.config

before_build:
  - ps: nuget restore

build:
  project: AjaxControlToolkit.sln
  publish_wap: true
  verbosity: minimal
  
after_build:
- ps: "New-Item AjaxControlToolkit.StaticResources\\Content\\AjaxControlToolkit\\Images -type directory\nNew-Item AjaxControlToolkit.StaticResources\\Content\\AjaxControlToolkit\\Styles -type directory\nNew-Item AjaxControlToolkit.StaticResources\\Scripts\\AjaxControlToolkit\\Debug -type directory\nNew-Item AjaxControlToolkit.StaticResources\\Scripts\\AjaxControlToolkit\\Release -type directory\n\nCopy-Item -Path AjaxControlToolkit.StaticResources\\Images\\* -Destination AjaxControlToolkit.StaticResources\\Content\\AjaxControlToolkit\\Images -Recurse \nCopy-Item -Path AjaxControlToolkit.StaticResources\\Styles\\* -Destination AjaxControlToolkit.StaticResources\\Content\\AjaxControlToolkit\\Styles -Recurse \nCopy-Item -Path AjaxControlToolkit.StaticResources\\Scripts\\Debug\\* -Destination AjaxControlToolkit.StaticResources\\Scripts\\AjaxControlToolkit\\Debug -Recurse \nCopy-Item -Path AjaxControlToolkit.StaticResources\\Scripts\\Release\\* -Destination AjaxControlToolkit.StaticResources\\Scripts\\AjaxControlToolkit\\Release -Recurse \n\nPush-Location -Path \"AjaxControlToolkit.StaticResources\"\n7z a ..\\AjaxControlToolkit.StaticResources.zip Content\\AjaxControlToolkit\\Images -ir!Content\\AjaxControlToolkit\\Styles\\* -ir!Scripts\\AjaxControlToolkit\\Debug\\* -ir!Scripts\\AjaxControlToolkit\\Release\\*\n\nPush-Location -Path \"..\\bin\\$env:CONFIGURATION\"\n7z a ..\\..\\..\\AjaxControlToolkit-nightly-$env:APPVEYOR_BUILD_NUMBER.zip AjaxControlToolkit.???\n\nPop-Location\nPop-Location"
  
artifacts:
  - path: AjaxControlToolkit-nightly-*.zip
  - path: AjaxControlToolkit.StaticResources.zip

test:
  assemblies: bin\$env:CONFIGURATION\AjaxControlToolkit.Tests.dll
 
services: iis
 
before_test:
- ps: "& \"C:\\Program Files\\IIS\\Microsoft Web Deploy V3\\msdeploy.exe\" -verb:sync -source:iisApp=\"$env:APPVEYOR_BUILD_FOLDER\\AjaxControlToolkit.Jasmine\" -dest:iisApp=`\"Default Web Site`\"\n\n\n$FilesAndFolders = gci \"C:\\inetpub\\wwwroot\" -recurse | % {$_.FullName}\nforeach($FileAndFolder in $FilesAndFolders)\n{\n    $item = gi -literalpath $FileAndFolder \n    $acl = $item.GetAccessControl() \n    $permission = \"Everyone\",\"FullControl\",\"Allow\"\n    $rule = New-Object System.Security.AccessControl.FileSystemAccessRule $permission\n    $acl.SetAccessRule($rule)\n    $item.SetAccessControl($acl)\n}"