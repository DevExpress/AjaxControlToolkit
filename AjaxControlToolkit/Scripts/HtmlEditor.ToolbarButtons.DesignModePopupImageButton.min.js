Type.registerNamespace("Sys.Extended.UI.HtmlEditor.ToolbarButtons"),Sys.Extended.UI.HtmlEditor.ToolbarButtons.DesignModePopupImageButton=function(e){Sys.Extended.UI.HtmlEditor.ToolbarButtons.DesignModePopupImageButton.initializeBase(this,[e]),this._relatedPopup=null,this._autoClose=!0,this._forclose_onmousedown$delegate=null},Sys.Extended.UI.HtmlEditor.ToolbarButtons.DesignModePopupImageButton.prototype={set_activeEditPanel:function(e){this._editPanel!=e&&null!=this._editPanel&&this.closePopup(),Sys.Extended.UI.HtmlEditor.ToolbarButtons.DesignModePopupImageButton.callBaseMethod(this,"set_activeEditPanel",[e])},get_autoClose:function(){return this._autoClose},set_autoClose:function(e){this._autoClose=e},get_relatedPopup:function(){return this._relatedPopup},set_relatedPopup:function(e){this._relatedPopup=e},openPopup:function(e,t,o){if((!this._autoClose||null==this._forclose_onmousedown$delegate)&&null!=this._relatedPopup){if(this._bookmark=null,Sys.Extended.UI.HtmlEditor.isIE){var n=this._designPanel._getSelection();this._selType=n.type.toLowerCase();var d=this._designPanel._createRange(n);if("text"==this._selType||"none"==this._selType)try{this._bookmark=d.duplicate()}catch(e){}else"control"==this._selType&&(this._bookmark=d.item(0),d.remove(0),n.empty())}if("function"==typeof this._relatedPopup.set_relatedElement){if(this._relatedPopup.set_relatedElement(this.get_element()),this._forclose_onmousedown$delegate=Function.createDelegate(this,this._forclose_onmousedown),this._autoClose){var s=this._designPanel.get_element().contentWindow,l=s.document.body,i=this;setTimeout(function(){null!=i._forclose_onmousedown$delegate&&(Sys.Extended.UI.HtmlEditor._addEvent(l,"mousedown",i._forclose_onmousedown$delegate),Sys.Extended.UI.HtmlEditor._addEvent(l,"keydown",i._forclose_onmousedown$delegate),Sys.Extended.UI.HtmlEditor._addEvent(document.body,"keydown",i._forclose_onmousedown$delegate),Sys.Extended.UI.HtmlEditor._addEvent(window,"keydown",i._forclose_onmousedown$delegate),Sys.Extended.UI.HtmlEditor._addEvent(s,"mousedown",i._forclose_onmousedown$delegate),Sys.Extended.UI.HtmlEditor._addEvent(document.body,"mousedown",i._forclose_onmousedown$delegate),document.documentElement&&Sys.Extended.UI.HtmlEditor._addEvent(document.documentElement,"mousedown",i._forclose_onmousedown$delegate))},0)}this._relatedPopup.open(e)}else this._relatedPopup.open(e,t,o)}},_forclose_onmousedown:function(e){if(null==this._forclose_onmousedown$delegate)return!0;if(!this._relatedPopup.isOpened)return!0;if(this._relatedPopup.close(),this._editPanel==Sys.Extended.UI.HtmlEditor.LastFocusedEditPanel)try{if(this._bookmark){if(Sys.Extended.UI.HtmlEditor.isIE){var t;"control"==this._selType?(t=this._designPanel._doc.body.createControlRange(),t.add(this._bookmark)):t=this._bookmark,t.select()}this._bookmark=null}if(!Sys.Extended.UI.HtmlEditor.isIE){var o=this._designPanel._getSelection(),t=this._designPanel._createRange(o);this._designPanel._removeAllRanges(o),this._designPanel._selectRange(o,t),this._designPanel.focusEditor()}}catch(e){}var n=this;if(setTimeout(function(){if(n._editPanel==Sys.Extended.UI.HtmlEditor.LastFocusedEditPanel)try{n._editPanel.updateToolbar()}catch(e){}},0),this._autoClose)try{var d=this._designPanel.get_element().contentWindow,s=d.document.body;document.documentElement&&Sys.Extended.UI.HtmlEditor._removeEvent(document.documentElement,"mousedown",this._forclose_onmousedown$delegate),Sys.Extended.UI.HtmlEditor._removeEvent(s,"keydown",this._forclose_onmousedown$delegate),Sys.Extended.UI.HtmlEditor._removeEvent(document.body,"keydown",this._forclose_onmousedown$delegate),Sys.Extended.UI.HtmlEditor._removeEvent(window,"keydown",this._forclose_onmousedown$delegate),Sys.Extended.UI.HtmlEditor._removeEvent(s,"mousedown",this._forclose_onmousedown$delegate),Sys.Extended.UI.HtmlEditor._removeEvent(d,"mousedown",this._forclose_onmousedown$delegate),Sys.Extended.UI.HtmlEditor._removeEvent(document.body,"mousedown",this._forclose_onmousedown$delegate)}catch(e){}return this._forclose_onmousedown$delegate=null,!e||!e.type||"keydown"!=e.type||(Sys.Extended.UI.HtmlEditor._stopEvent(e),!1)},closePopup:function(){null!=this._forclose_onmousedown$delegate&&this._forclose_onmousedown$delegate(null)},dispose:function(){null!=this._forclose_onmousedown$delegate&&this._forclose_onmousedown$delegate(null),Sys.Extended.UI.HtmlEditor.ToolbarButtons.DesignModePopupImageButton.callBaseMethod(this,"dispose")}},Sys.Extended.UI.HtmlEditor.ToolbarButtons.DesignModePopupImageButton.registerClass("Sys.Extended.UI.HtmlEditor.ToolbarButtons.DesignModePopupImageButton",Sys.Extended.UI.HtmlEditor.ToolbarButtons.MethodButton);