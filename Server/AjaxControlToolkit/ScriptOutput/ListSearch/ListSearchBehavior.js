// (c) 2010 CodePlex Foundation
(function(){var b="ExtendedListSearch";function a(){var d=true,e="keypress",c="",b=false,a=null;Type.registerNamespace("Sys.Extended.UI");Sys.Extended.UI.ListSearchBehavior=function(e){var d=this;Sys.Extended.UI.ListSearchBehavior.initializeBase(d,[e]);d._promptCssClass=a;d._promptText=Sys.Extended.UI.Resources&&Sys.Extended.UI.Resources.ListSearch_DefaultPrompt||"Type to search";d._offsetX=0;d._offsetY=0;d._promptPosition=Sys.Extended.UI.ListSearchPromptPosition.Top;d._raiseImmediateOnChange=b;d._queryPattern=Sys.Extended.UI.ListSearchQueryPattern.StartsWith;d._isSorted=b;d._popupBehavior=a;d._onShowJson=a;d._onHideJson=a;d._originalIndex=0;d._newIndex=-1;d._showingPromptText=b;d._searchText=c;d._ellipsis=String.fromCharCode(8230);d._binarySearch=b;d._applicationLoadDelegate=a;d._focusIndex=0;d._queryTimeout=0;d._timer=a;d._matchFound=b;d._focusHandler=a;d._blurHandler=a;d._keyDownHandler=a;d._keyUpHandler=a;d._keyPressHandler=a};Sys.Extended.UI.ListSearchBehavior.prototype={initialize:function(){var a=this;Sys.Extended.UI.ListSearchBehavior.callBaseMethod(a,"initialize");var b=a.get_element();if(b&&b.tagName==="SELECT"){a._focusHandler=Function.createDelegate(a,a._onFocus);a._blurHandler=Function.createDelegate(a,a._onBlur);a._keyDownHandler=Function.createDelegate(a,a._onKeyDown);a._keyUpHandler=Function.createDelegate(a,a._onKeyUp);a._keyPressHandler=Function.createDelegate(a,a._onKeyPress);$addHandler(b,"focus",a._focusHandler);$addHandler(b,"blur",a._blurHandler);$addHandler(b,"keydown",a._keyDownHandler);$addHandler(b,"keyup",a._keyUpHandler);$addHandler(b,e,a._keyPressHandler);a._applicationLoadDelegate=Function.createDelegate(a,a._onApplicationLoad);Sys.Application.add_load(a._applicationLoadDelegate)}},dispose:function(){var b=this,c=b.get_element();$removeHandler(c,e,b._keyPressHandler);$removeHandler(c,"keyup",b._keyUpHandler);$removeHandler(c,"keydown",b._keyDownHandler);$removeHandler(c,"blur",b._blurHandler);$removeHandler(c,"focus",b._focusHandler);b._onShowJson=a;b._onHideJson=a;b._disposePopupBehavior();if(b._applicationLoadDelegate){Sys.Application.remove_load(b._applicationLoadDelegate);b._applicationLoadDelegate=a}b._timer&&b._stopTimer();Sys.Extended.UI.ListSearchBehavior.callBaseMethod(b,"dispose")},_onApplicationLoad:function(){var e=b,d=Sys.Extended.UI.ListSearchBehavior.callBaseMethod(this,"get_ClientState");if(d!=a&&d!=c){e=d==="Focused";Sys.Extended.UI.ListSearchBehavior.callBaseMethod(this,"set_ClientState",a)}e&&this._handleFocus()},_checkIfSorted:function(g){if(this._isSorted)return d;else{for(var c=a,h=g.length,e=0;e<h;e++){var f=g[e].text.toLowerCase();if(c&&this._compareStrings(f,c)<0)return b;c=f}return d}},_onFocus:function(){this._handleFocus()},_handleFocus:function(){var a=this,b=a.get_element();a._focusIndex=b.selectedIndex;if(!a._promptDiv){a._promptDiv=document.createElement("div");a._promptDiv.id=b.id+"_promptDiv";a._promptDiv.innerHTML=a._promptText&&a._promptText.length>0?a._promptText:Sys.Extended.UI.Resources.ListSearch_DefaultPrompt;a._showingPromptText=d;if(a._promptCssClass)a._promptDiv.className=a._promptCssClass;b.parentNode.insertBefore(a._promptDiv,b.nextSibling);a._promptDiv.style.overflow="hidden";a._promptDiv.style.height=a._promptDiv.offsetHeight+"px";a._promptDiv.style.width=b.offsetWidth+"px"}if(!a._popupBehavior)a._popupBehavior=$create(Sys.Extended.UI.PopupBehavior,{parentElement:b},{},{},a._promptDiv);if(a._promptPosition&&a._promptPosition==Sys.Extended.UI.ListSearchPromptPosition.Bottom)a._popupBehavior.set_positioningMode(Sys.Extended.UI.PositioningMode.BottomLeft);else a._popupBehavior.set_positioningMode(Sys.Extended.UI.PositioningMode.TopLeft);a._onShowJson&&a._popupBehavior.set_onShow(a._onShowJson);a._onHideJson&&a._popupBehavior.set_onHide(a._onHideJson);a._popupBehavior.show();a._updatePromptDiv(a._promptText)},_onBlur:function(){var b=this;b._disposePopupBehavior();var c=b._promptDiv,d=b.get_element();if(c){b._promptDiv=a;c.parentNode.removeChild(c)}!b._raiseImmediateOnChange&&b._focusIndex!=d.selectedIndex&&b._raiseOnChange(d)},_disposePopupBehavior:function(){if(this._popupBehavior){this._popupBehavior.dispose();this._popupBehavior=a}},_onKeyDown:function(e){var a=this,d=a.get_element(),f=a._promptDiv;if(!d||!f)return;a._originalIndex=d.selectedIndex;if(a._showingPromptText){f.innerHTML=c;a._searchText=c;a._showingPromptText=b;a._binarySearch=a._checkIfSorted(d.options)}if(e.keyCode==Sys.UI.Key.backspace){e.preventDefault();e.stopPropagation();a._removeCharacterFromPromptDiv();a._searchForTypedText(d);(!a._searchText||a._searchText.length==0)&&a._stopTimer()}else if(e.keyCode==Sys.UI.Key.esc){e.preventDefault();e.stopPropagation();f.innerHTML=c;a._searchText=c;a._searchForTypedText(d);a._stopTimer()}else if(e.keyCode==Sys.UI.Key.enter&&!a._raiseImmediateOnChange&&a._focusIndex!=d.selectedIndex){a._focusIndex=d.selectedIndex;a._raiseOnChange(d)}},_onKeyUp:function(){var a=this,d=a.get_element(),b=a._promptDiv;if(!d||!b)return;if(a._newIndex==-1||!d||!b||b.innerHTML==c){a._newIndex=-1;return}d.selectedIndex=a._newIndex;a._newIndex=-1},_onKeyPress:function(b){var a=this,c=a.get_element(),d=a._promptDiv;if(!c||!d)return;if(!a._isNormalChar(b)){if(b.charCode==Sys.UI.Key.backspace){b.preventDefault();b.stopPropagation();a._searchText&&a._searchText.length==0&&a._stopTimer()}return}b.preventDefault();b.stopPropagation();a._addCharacterToPromptDiv(b.charCode);a._searchForTypedText(c);a._stopTimer();a._searchText&&a._searchText.length!=0&&a._startTimer()},_isNormalChar:function(a){return Sys.Browser.agent==Sys.Browser.Firefox&&a.rawEvent.keyCode?b:Sys.Browser.agent==Sys.Browser.Opera&&a.rawEvent.which==0?b:a.charCode&&(a.charCode<Sys.UI.Key.space||a.charCode>6e3)?b:d},_updatePromptDiv:function(f){var d=this,a=d._promptDiv;if(!a||!d.get_element())return;var b=typeof f==="undefined"?d._searchText:f,c=a.firstChild;if(!c){c=document.createTextNode(b);a.appendChild(c)}else c.nodeValue=b;if(a.scrollWidth<=a.offsetWidth&&a.scrollHeight<=a.offsetHeight)return;for(var e=b.length-1;e>0&&(a.scrollWidth>a.offsetWidth||a.scrollHeight>a.offsetHeight);e--)c.nodeValue=d._ellipsis+b.substring(b.length-e,b.length)},_addCharacterToPromptDiv:function(a){this._searchText+=String.fromCharCode(a);this._updatePromptDiv()},_removeCharacterFromPromptDiv:function(){var a=this;if(a._searchText&&a._searchText!=c){a._searchText=a._searchText.substring(0,a._searchText.length-1);a._updatePromptDiv()}},_searchForTypedText:function(f){var a=this,i=a._searchText,g=f.options,h=i?i.toLowerCase():c;a._matchFound=b;if(h.length==0){if(g.length>0){f.selectedIndex=0;a._newIndex=0}}else{var e=-1;if(a._binarySearch&&a._queryPattern==Sys.Extended.UI.ListSearchQueryPattern.StartsWith)e=a._doBinarySearch(g,h,0,g.length-1);else e=a._doLinearSearch(g,h,0,g.length-1);if(e==-1)a._newIndex=a._originalIndex;else{f.selectedIndex=e;a._newIndex=e;a._matchFound=d}}a._raiseImmediateOnChange&&a._originalIndex!=f.selectedIndex&&a._raiseOnChange(f)},_raiseOnChange:function(c){if(document.createEvent){var a=document.createEvent("HTMLEvents");a.initEvent("change",d,b);c.dispatchEvent(a)}else document.createEventObject&&c.fireEvent("onchange")},_compareStrings:function(a,b){return a==b?0:a<b?-1:1},_doBinarySearch:function(f,c,d,b){while(d<=b){var a=Math.floor((d+b)/2),g=f[a].text.toLowerCase().substring(0,c.length),e=this._compareStrings(c,g);if(e>0)d=a+1;else if(e<0)b=a-1;else{while(a>0&&f[a-1].text.toLowerCase().startsWith(c))a--;return a}}return-1},_doLinearSearch:function(b,d,e,c){if(this._queryPattern==Sys.Extended.UI.ListSearchQueryPattern.Contains){for(var a=e;a<=c;a++)if(b[a].text.toLowerCase().indexOf(d)>=0)return a}else if(this._queryPattern==Sys.Extended.UI.ListSearchQueryPattern.StartsWith)for(var a=e;a<=c;a++)if(b[a].text.toLowerCase().startsWith(d))return a;return-1},_onTimerTick:function(){var a=this;a._stopTimer();if(!a._matchFound){a._searchText=c;a._updatePromptDiv()}},_startTimer:function(){var a=this;if(a._queryTimeout>0)a._timer=window.setTimeout(Function.createDelegate(a,a._onTimerTick),a._queryTimeout)},_stopTimer:function(){this._timer!=a&&window.clearTimeout(this._timer);this._timer=a},get_onShow:function(){return this._popupBehavior?this._popupBehavior.get_onShow():this._onShowJson},set_onShow:function(b){var a=this;if(a._popupBehavior)a._popupBehavior.set_onShow(b);else a._onShowJson=b;a.raisePropertyChanged("onShow")},get_onShowBehavior:function(){return this._popupBehavior?this._popupBehavior.get_onShowBehavior():a},onShow:function(){this._popupBehavior&&this._popupBehavior.onShow()},get_onHide:function(){return this._popupBehavior?this._popupBehavior.get_onHide():this._onHideJson},set_onHide:function(b){var a=this;if(a._popupBehavior)a._popupBehavior.set_onHide(b);else a._onHideJson=b;a.raisePropertyChanged("onHide")},get_onHideBehavior:function(){return this._popupBehavior?this._popupBehavior.get_onHideBehavior():a},onHide:function(){this._popupBehavior&&this._popupBehavior.onHide()},get_promptText:function(){return this._promptText},set_promptText:function(a){if(this._promptText!=a){this._promptText=a;this.raisePropertyChanged("promptText")}},get_promptCssClass:function(){return this._promptCssClass},set_promptCssClass:function(a){if(this._promptCssClass!=a){this._promptCssClass=a;this.raisePropertyChanged("promptCssClass")}},get_promptPosition:function(){return this._promptPosition},set_promptPosition:function(a){if(this._promptPosition!=a){this._promptPosition=a;this.raisePropertyChanged("promptPosition")}},get_raiseImmediateOnChange:function(){return this._raiseImmediateOnChange},set_raiseImmediateOnChange:function(a){if(this._raiseImmediateOnChange!=a){this._raiseImmediateOnChange=a;this.raisePropertyChanged("raiseImmediateOnChange")}},get_queryTimeout:function(){return this._queryTimeout},set_queryTimeout:function(a){if(this._queryTimeout!=a){this._queryTimeout=a;this.raisePropertyChanged("queryTimeout")}},get_isSorted:function(){return this._isSorted},set_isSorted:function(a){if(this._isSorted!=a){this._isSorted=a;this.raisePropertyChanged("isSorted")}},get_queryPattern:function(){return this._queryPattern},set_queryPattern:function(a){if(this._queryPattern!=a){this._queryPattern=a;this.raisePropertyChanged("queryPattern")}}};Sys.Extended.UI.ListSearchBehavior.registerClass("Sys.Extended.UI.ListSearchBehavior",Sys.Extended.UI.BehaviorBase);Sys.registerComponent(Sys.Extended.UI.ListSearchBehavior,{name:"listSearch"});Sys.Extended.UI.ListSearchPromptPosition=function(){throw Error.invalidOperation();};Sys.Extended.UI.ListSearchPromptPosition.prototype={Top:0,Bottom:1};Sys.Extended.UI.ListSearchPromptPosition.registerEnum("Sys.Extended.UI.ListSearchPromptPosition");Sys.Extended.UI.ListSearchQueryPattern=function(){throw Error.invalidOperation();};Sys.Extended.UI.ListSearchQueryPattern.prototype={StartsWith:0,Contains:1};Sys.Extended.UI.ListSearchQueryPattern.registerEnum("Sys.Extended.UI.ListSearchQueryPattern")}if(window.Sys&&Sys.loader)Sys.loader.registerScript(b,["ExtendedPopupBehavior"],a);else a()})();